# 00、Question

##### 1、具体是怎么优化的

##### 2、怎么找到和P~n~距离相近的之前点

##### 3、两次P~n~的评估如何加权，或者说各自权重如何计算

##### 4、为什么马氏距离中要用协方差矩阵的逆

用于消除scale对距离的影响。在一维的情况中，比如两个维度的距离都是3，但对于方差大的数据，这个距离为3的样本点更有可能不离群，所以要用距离再除以方差，消除方差的影响。高维情况下就是乘以协方差的逆。

##### 5、为什么3.1中的协方差矩阵是$\Delta D_{ij}$的，3.2中协方差矩阵是$D_{ij}$的。

##### 6、为什么$D = \overline{H} \Delta V$

# 01、概念

##### 1、[协方差矩阵](https://blog.csdn.net/sherrylml/article/details/48753673)

[协方差矩阵的详细说明_协方差矩阵怎么看_zaf赵的博客-CSDN博客](https://blog.csdn.net/zaf0516/article/details/36033955)

##### 2、[马氏距离](https://zhuanlan.zhihu.com/p/46626607)

评定数据之间的相似性。

##### 3、测量方程

是将观测到的测量值与系统中的未知变量或参数联系起来的数学表达式。

在扫描数据(点云或图像)的匹配过程中，使用测量方程来制定对传感器帧相对位姿的约束条件。

这些方程定义了观测到的距离扫描或里程测量值与帧的未知姿势之间的关系。

##### 4、最优估计

根据可用数据确定某些参数或者变量的最准确和最可靠值的过程。

##### 5、最大似然估计

##### 6、似然函数

用于衡量给定一组特定参数时，获得一组观测数据的概率。

##### 7、最小方差



# 1、Introduction

##### 动机：单独的里程计信息不足以确定相对扫描姿态，因为里程计误差会累积。 

构建世界模型的一种常用方法将新数据集成到模型中。当获得每一帧传感器数据时，它与前一帧或累积全局模型对齐，然后通过平均数据或使用卡尔曼滤波器将新的数据整合到全局模型中。这种方法的问题是：模型的不同部分被独立更新，最终得到的世界模型可能会变得不一致。另外，如果数据帧已经永久集成，很难解决这种不一致。

![image-20230519094927382](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20230519094927382.png)

- 如图a所示，机器人从P~1~出发依次经过P~2~,...,P~n-1~,到达P~1~附近的位置P~n~。
- 通过将P~n~处记录的扫描和P~n-1~相匹配，可以估计出P~n~处的位姿。
- 由于P~n~接近P~1~，也可以通过匹配这两个扫描，基于P~1~推导出P~n~的姿态。
- 由于误差的存在，这两个P~n~的评估会产生冲突。
- 如果通过用两者的加权平均表示最终的P~n~位姿评估，P~n-1~也应该被更新，否则P~n-1~P~n~的匹配关系将与之前的关系冲突。
- 同样，沿着路径的其他位姿也应该更新。

# 2、Approach

## 2.1 获得位姿之间的关系

粗略的估计：

- 直接从**里程计**中获得。

精准的估计：

- 通过对点的==成对扫描==进行配准，可以获得更精确的扫描位姿关系。将两次扫描和对它们相对姿态的粗略初始估计(例如来自里程计)作为输入。输出是相对姿态的改进估计。 

对齐两个扫描之后，我们可以记录两个扫描中一系列对应的点。这个点集合可以在两个位姿之间形成约束。

如何判断两个扫描之间是否需要获得位姿关系？

- 当我们匹配两个扫描时，先将一个扫描投影到另一个扫描的局部坐标系中，并丢弃在第二个姿态中不可见的点。
- 根据两次扫描之间匹配部分的空间范围，经验地估计两次扫描之间的重叠值。
- 只有当重叠值大于一定阈值，才会导出位姿关系。

## 2.2 构建位姿关系网络

网络的组成：

- 一系列的节点。代表机器人在其轨迹上的位姿。用向量$(x,y,θ)^t$表示，包含一个2D的机器人位置和==旋转距离传感器的主方向==。
- 一对节点之间的边。两个类型。
  - 如果两个位姿在机器人路径上相邻，我们说两个节点之间存在一个**弱链接**，这是相对姿态的里程计测量。
  - 如果两个姿态记录的扫描有足够的重叠，我们就说两个节点之间存在**强链接**。

## 2.3 组合网络中的位姿关系

一个网络中的位姿关系可能不一致，因为它们不是独立的变量。所以需要组合所有的位姿关系并解决任何不一致。

该问题被描述为网络中节点的全局姿态的最优估计问题。

我们不直接处理这些关系。相反，==我们首先求解一组构成自由变量的节点。然后通过节点上的位姿定义一组表示所有先验关系折中的一致关系。==

最优化目标函数

- 网络中的每个边都被转换为目标函数中的一项，可以想象成连接两个节点的弹簧。
- 当两个节点的位姿关系与观测值(从里程计获得或者从两个匹配的扫描中获得)相等时，弹簧能量最小。
- 目标函数代表整个网络的能量。通过最小化整体能量函数，一次性解出所有位姿变量。

## 2.4 一个三节点的示例

假设网络组成：

- 三个节点：P~1~，P~2~，P~3~
- 三个关系：$T_1=P_1P_2,T_2=P_2P_3,T_3=P_3P_1$

当有个T~1~有了新的测量值$\overline{T}_1$。

- 先前的方法
  - 通过准则$T_1'T_2'T_3'=I$ 来更新三个关系$T_1',T_2',T_3'$
- 该方法
  - 将$T_1,T_2,T_3$和$\overline{T}_1$一起组成一个优化问题，并解出新的节点位姿$P_1',P_2',P_3'$
  - 三个新的节点位姿组成了新的关系$T_1'=P_1'P_2',T_2'=P_2'P_3',T_3'=P_3'P_1'$
  - ==注意，节点位置是自由变量，因此我们不需要求解复杂的约束系统==

第三节：考虑一个一般的最优估计问题来给出优化准则

第四节：给出了距离扫描配准中的位姿关系和目标函数，应用第三节中导出的封闭形式解来求解扫描位姿。

# 3、 关系网络的最优估计

## 3.1 优化问题的定义

##### 问题建模：

假设我们有一个网络，包含n+1个不确定测量节点：$X_0，X_1,...,X_n$.<!--测量的位置可能与真实位置相比有误差-->

- $X_i$表示一个d维位姿向量。
- $X_i$和$X_j$之间的连接$D_{ij}$表示两个节点位姿之间的可测量差异。
- 通常$D_{ij}$是$X_i$和$X_j$的函数，我们将此函数称为测量方程。特别感兴趣的测量方程维$D_{ij}=X_i-X_j$的简单线性情况。
- 我们将$D_{ij}$的观测建模为$\overline{D}_{ij}=D_{ij}+△D_{ij}$,其中$△D_{ij}$是具有零均值和已知的协方差矩阵$C_{ij}$的随机高斯误差。

给定一组成对节点之间的**测量值$\overline{D}_{ij}$**和协方差矩阵C~ij~<!--协方差矩阵捕捉了由于噪声和其他误差导致的空间关系的不确定性-->

##### 优化目标：

通过合并所有的测量值$\overline{D}_{ij}$，得出$X_i$位置的最佳估计。

##### 最优估计方法：

基于==最大似然==或==最小方差==

确定节点位置X~i~（和根据X~i~得到的位置差D~ij~）：

- 在给定观测值$\overline{D}_{ij}$的情况下，==导出的$D_{ij}$联合概率最大==

- 我们假设所有的观测误差都是高斯的且相互独立，==则该标准等效于**最小化**以下**马氏距离**==

  ==$W = \sum_{i,j}  (D_{ij}-\overline{D}_{ij})^t C_{ij}^{-1} (D_{ij}-\overline{D}_{ij}) $==

## 3.2 考虑最简单的线性情况

##### 问题建模：

设测量方程为最简单的线性形式
$$
D_{ij}=X_i-X_j
$$

- $X_i,i=0,1,...,n$是网络中的节点
- $D_{ij}$是网络中的边
- 在不失一般性的情况下，我们假设每对节点$X_i,X_j$之间存在链路$D_{ij}$
- 对于每个$D_{ij}$,我们有一个观测到的$\overline{D}_{ij}$，它有着均值$D_{ij}$和协方差$C_{ij}$

##### 优化目标：

最小化以下马氏距离

$$
W = \sum_{o≤j<j≤n}(X_i-X_j-\overline{D}_{ij})^t
C_{ij}^{-1}
(X_i-X_j-\overline{D}ij).
$$

##### 矩阵形式：

测量方程转换为矩阵形式
$$
D = HX
$$

- X是n×d维的向量，由$X_1,X_2,...,X_n$串联而成
- D是所有$D_{ij}$串联
- H为关联矩阵，所有的值都为1、-1或0

马氏距离为：
$$
W = (HX-\overline{D})^t
C^{-1}
(HX-\overline{D}ij).
$$

- $\overline{D}$是所有$\overline{D}_{ij}$的串联
- C是协方差矩阵

那么最小化W的解X为：
$$
X = (H^t C^{-1}H)^{-1} H^t C^{-1} \overline{D}
$$
X的协方差矩阵为：
$$
C_X = (H^t C^{-1} H)^{-1}
$$
定义一个nd×nd的矩阵$G = H^t C^{-1}H$,并且展开矩阵乘法，可以得到G的n×n的矩阵
$$
G_{ii} = \sum^n_{j=0}C_{ij}^{-1} 
\\ G_{ij} = -C^{-1}_{ij}  \space(i ≠ j)
$$
定义$B = H^tC^{-1}\overline{D}$

则位姿的估计X和它的协方差可以被写为
$$
X = G^{-1}B; \space C_x = G^{-1}
$$

## 3.3 特殊的网络示例

略

# 4、位姿关系的推导

本节将把第三节中导出的最优估计算法应用于机器人位姿估计和扫描数据配准问题上。

为此，我们需要导出姿态关系的线性化方程。

## 4.1 位姿复合操作符

我们假设机器人从位姿$V_b = (x_b, y_b, \theta_b)^t$开始运动，然后它的位姿相对于$V_b$改变了$D = (x,y,\theta)^t$, 最终达到了一个新的位姿$V_a = (x_a, y_a, \theta_a)^t$

我们称$V_a$为$V_b$和$D$的复合
$$
V_a = V_b ⊕D
$$
具体变换关系如下：

![image-20231109214311390](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231109214311390.png)

同理也可以定义一个复合操作的逆变换
$$
D = V_a \ominus V_b
$$
具体变换关系如下：

![image-20231109214643692](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231109214643692.png)

## 4.2 从配准的扫描中获取位姿关系

通过扫描配准方法，我们得到一系列对应的点$u_k^a,u_k^b,k = 1,...,m$

 $(u^a_k,u^b_k)$代表着从不同的局部坐标中表示的环境中相同的物理点

忽略传感误差和匹配误差可得：

![image-20231110101103850](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110101103850.png)

如果考虑随机观测误差，$\Delta Z_k$是一个均值为零，协方差为未知的$C^Z_k$

##### 我们的目标是最小化下列随机误差：

![image-20231110101317833](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110101317833.png)

即

![image-20231110101333283](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110101333283.png)

- $D’ = V_a \ominus V_b $为观测方程

##### 将$F_{ab}$简化成马氏距离的形式

我们将每一项$\Delta Z_k$线性化，使用泰勒展开式：

![image-20231110102701112](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110102701112.png)

其中：

![image-20231110102729836](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110102729836.png)

令

![image-20231110103309857](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110103309857.png)

可得

![image-20231110103327927](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110103327927.png)

- 线性化后，D可以代替$D’ = V_a \ominus V_b $ 作为观测方程

##### 对于m个匹配点，将上述公式转换为矩阵形式

![image-20231110104235862](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110104235862.png)

可以得到最小化$F_{ab}$的D值为$\overline{D}$，即最小二乘的解为

![image-20231110105218705](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110105218705.png)

在$\Delta Z_k ≈ 。。。$中，$M_k$是已知的， $\overline{Z}$是观测到的具有

最小二乘的解$\overline{D}$具有高斯分布，并且它的协方差矩阵由下式给出：

![image-20231110122443173](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110122443173.png)



![image-20231110122617488](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110122617488.png)

注意到$F_{ab}$可以被写为

![image-20231110122730934](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110122730934.png)

最终得到

![image-20231110105851720](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110105851720.png)

## 4.3 从里程计中获得位姿关系

同理，也可以得到

![image-20231110105805275](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110105805275.png)

## 4.4 最优位姿估计

对于n个机器人位姿$V_i,i = 0,1,...,n$，最终的代价函数为：

![image-20231110110230310](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110110230310.png)

- $D_{ij}$是$V_j$和$V_i$的线性化位姿差

  ![image-20231110112248762](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110112248762.png)

  - $X_i = \overline{H}_i \Delta V_i$ 为节点的状态向量

- $\overline{D}$是观测到的$D_{ij}$

根据第三节的推到可得

![image-20231110115201476](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110115201476.png)

注意：位姿估计$V_i$和协方差$C_i$基于假设$V_0$ = 0

若$V_0 =(x_0, y_0, \theta _0)^t$

则方程的解应该转换为

![image-20231110120040388](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110120040388.png)

- 其中![image-20231110120054357](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231110120054357.png)

# 二、十四讲中的图优化

![image-20231109153531660](https://raw.githubusercontent.com/letMeEmoForAWhile/typoraImage/main/img/image-20231109153531660.png)

BA与图优化的关系

- BA虽然是个纯优化问题，但是也可以用图模型清晰地表达出来
- 顶点为优化变量，边为运动/观测模型
- 本身还有一些特殊结构

# 三、g2o
